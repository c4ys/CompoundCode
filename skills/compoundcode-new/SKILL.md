---
name: compoundcode-new
description: 创建新的变更请求。当用户要求"创建新变更"、"新功能"、"新 feature"、"compoundcode new"、"开始新任务"、"添加新需求"时使用此 skill。引导用户通过问答生成 spec.md 和 plan.md，支持 Feature/Bug/Chore 类型。
---

# CompoundCode New

创建新的变更请求，在 `compound/changes/` 目录下生成 spec.md 和 plan.md。

## 前置条件

检查 `compound/` 目录是否存在。如果不存在：
- 提示用户先运行 `/compoundcode:init` 初始化项目
- 停止执行

## 工作流程

**重要：每次只问一个问题，等待用户回答后再继续。**

### 步骤 1：获取变更描述

如果用户未提供描述，询问：

```
**变更描述**

请简要描述这次变更的内容（一句话）：
```

### 步骤 2：推断变更类型

根据描述自动推断类型，然后确认：

```
**变更类型**

根据描述，这是一个 [推断的类型]。

选项：
- A) Feature（新功能）
- B) Bug（修复问题）
- C) Chore（维护/重构）
- D) 自定义输入

请选择 (A/B/C/D)：
```

### 步骤 3：交互式生成 spec.md

根据变更类型，使用不同的问题集。

#### 问题分类规则

**Additive（加法型）**：收集多个想法，添加 "(可多选)"
- 目标用户、成功标准、影响范围

**Exclusive Choice（排他型）**：单一决策，不添加 "(可多选)"
- 技术选择、优先级

#### Feature 类型问题（3-5 个）

**问题 1/4：功能目标** (Exclusive)
```
**问题 1/4：功能目标**

这个功能要解决什么问题？

选项：
- A) [根据上下文生成的选项]
- B) [根据上下文生成的选项]
- C) 自定义输入

请选择或输入：
```

**问题 2/4：目标用户** (Additive)
```
**问题 2/4：目标用户** (可多选)

谁会使用这个功能？

选项：
- A) 开发者
- B) 终端用户
- C) 管理员
- D) 自定义输入

请选择 (可多选，如 A,B)：
```

**问题 3/4：成功标准** (Additive)
```
**问题 3/4：成功标准** (可多选)

如何判断这个功能成功完成？

选项：
- A) [根据功能生成的标准]
- B) [根据功能生成的标准]
- C) 自定义输入

请选择或输入：
```

**问题 4/4：技术考虑** (Exclusive)
```
**问题 4/4：技术考虑**

实现时需要特别注意什么？

选项：
- A) 无特殊考虑
- B) 需要兼容现有系统
- C) 需要高性能
- D) 自定义输入

请选择：
```

#### Bug 类型问题（2-3 个）

**问题 1/3：问题描述**
```
**问题 1/3：问题描述**

请描述遇到的问题：
```

**问题 2/3：复现步骤**
```
**问题 2/3：复现步骤**

如何复现这个问题？

选项：
- A) 每次都能复现
- B) 偶尔出现
- C) 只在特定条件下出现
- D) 自定义输入

请选择并描述步骤：
```

**问题 3/3：预期行为**
```
**问题 3/3：预期行为**

正确的行为应该是什么？
```

#### Chore 类型问题（2-3 个）

**问题 1/2：改进范围**
```
**问题 1/2：改进范围** (可多选)

这次改进涉及哪些方面？

选项：
- A) 代码重构
- B) 性能优化
- C) 依赖更新
- D) 文档完善
- E) 自定义输入

请选择 (可多选)：
```

**问题 2/2：改进目标**
```
**问题 2/2：改进目标**

这次改进要达到什么效果？
```

### 步骤 4：生成 spec.md 草稿

根据收集的信息生成 spec.md 草稿。

```markdown
# [变更名称]

## 概述

[变更描述]

## 类型

[Feature/Bug/Chore]

## 背景

[为什么需要这个变更]

## 需求

### 功能需求

- [ ] [需求 1]
- [ ] [需求 2]

### 非功能需求

- [ ] [需求]

## 验收标准

- [ ] [标准 1]
- [ ] [标准 2]

## 影响范围

[受影响的模块/文件]

## 风险评估

[潜在风险及缓解措施]
```

展示给用户确认：
```
**spec.md 草稿**

[显示生成的内容]

选项：
- A) 批准
- B) 修改（请说明要修改的内容）

请选择：
```

如果用户选择修改，根据反馈更新，再次确认。

### 步骤 5：交互式生成 plan.md

读取确认的 spec.md 和 `compound/workflow.md`。

**问题 1/2：任务分解**
```
**问题 1/2：任务分解**

基于 spec，我建议将实施分为以下阶段：

1. [阶段 1]
2. [阶段 2]
3. [阶段 3]

选项：
- A) 同意这个分解
- B) 调整分解（请说明）

请选择：
```

**问题 2/2：测试策略**
```
**问题 2/2：测试策略**

测试策略：

选项：
- A) TDD（先写测试，再实现）
- B) 实现后补测试
- C) 不需要测试
- D) 自定义策略

请选择：
```

生成 plan.md 草稿：

```markdown
# [变更名称] - 实施计划

## 概述

基于 [spec.md](./spec.md) 的实施计划。

## 任务分解

### 阶段 1: [阶段名称]

**目标**: [阶段目标]

**任务**:
- [ ] 1.1 [任务描述]
  - 文件: `path/to/file`
  - 步骤: [具体步骤]
- [ ] 1.2 [任务描述]

**验证**: [如何验证阶段完成]

### 阶段 2: [阶段名称]

[类似结构]

### 阶段 3: 测试与验证

- [ ] 3.1 运行测试
- [ ] 3.2 代码审查
- [ ] 3.3 文档更新

## 依赖

[列出依赖的其他任务或资源]

## 进度跟踪

| 任务 | 状态 | 完成时间 | Commit |
|------|------|----------|--------|
| - | - | - | - |
```

展示给用户确认：
```
**plan.md 草稿**

[显示生成的内容]

选项：
- A) 批准
- B) 修改（请说明要修改的内容）

请选择：
```

### 步骤 6：创建变更目录和文件

1. 生成变更 ID：`YYYY-MM-DD-short-name`
2. 创建目录：`compound/changes/[变更ID]/`
3. 写入文件：
   - `spec.md` - 确认的规格
   - `plan.md` - 确认的计划
   - `metadata.json` - 元数据

**metadata.json 格式**：
```json
{
  "id": "2026-01-27-feature-name",
  "type": "feature",
  "status": "planned",
  "created_at": "2026-01-27T10:00:00Z",
  "title": "变更标题",
  "description": "变更描述"
}
```

### 步骤 7：更新索引

在 `compound/specs/index.md` 中添加新变更的链接。

### 步骤 8：完成

展示摘要：
```
**变更创建完成！**

已创建以下文件：
- compound/changes/[变更ID]/spec.md
- compound/changes/[变更ID]/plan.md
- compound/changes/[变更ID]/metadata.json

下一步：
1. 按照 plan.md 中的步骤实施
2. 完成后更新任务状态
3. 将经验整合到 specs/ 文档中
```

## 问答格式

```
**问题 X/Y: [主题]** [(可多选)]

[上下文说明（如有）]

选项：
- A) [选项 A 说明]
- B) [选项 B 说明]
- C) [选项 C 说明]
- D) 自定义输入

请选择 [(可多选，如 A,B)]：
```

## 确认循环

生成文档后：
1. 展示草稿
2. 等待用户反馈（批准/修改）
3. 如果修改，根据反馈更新
4. 重复直到用户批准

## 上下文感知

生成问题选项时，参考：
- `compound/project.md` - 项目背景
- `compound/techstack.md` - 技术栈
- `compound/architecture.md` - 架构设计
- `compound/workflow.md` - 工作流程

## 错误处理

- `compound/` 不存在：提示运行 `/compoundcode:init`
- 变更 ID 重复：自动添加序号后缀
- 用户取消：不创建任何文件
